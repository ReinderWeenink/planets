version: '3.8'

services:
  backend-app:
    # 1. Build the image using the Dockerfile located in the current directory ('.').
    build:
      context: .
    
    # 2. Map the container port (80) to the host port (80).
    ports:
      - "80:80" 
      
    # 3. Assign a friendly name to the container instance.
    container_name: planet_name_generator
    
    # 4. Configure the container to restart automatically unless it is explicitly stopped.
    restart: unless-stopped
    
    # 5. Health Check configuration
    healthcheck:
      # Uses Python native check (no curl required)
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost/health')"]
      start_period: 5s 
      interval: 30s
      timeout: 10s
      retries: 3

  # 6. Test Runner Service
  test-runner:
    build:
      context: .
    container_name: integration_tester
    environment:
      # We use the internal service name 'backend-app' instead of 'localhost'
      - TEST_URL=http://backend-app:80
    
    # Mount tests AND pyproject.toml (for configuration)
    volumes:
      - ./tests:/app/tests
      - ./pyproject.toml:/app/pyproject.toml
      
    depends_on:
      backend-app:
        condition: service_healthy
    
    # FIX: Use 'python' directly instead of 'uv run'.
    # This uses the packages already installed in the image, avoiding the need for a README.md or a rebuild.
    command: ["python", "-m", "pytest", "tests/test_integration.py"]